<!DOCTYPE html>

<!--Low voltage disconnect customer form
    Programmed by Henry Holben using some code generated by ChatGPT, https://chat.openai.com/


-->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Code Generator</title>
</head>
<body>
    <h1>Arduino Code Generator</h1>
    <img src="LVDCpreliminarylogoV2.png" alt="LVDC Team Logo: A buff, happy battery in a life saver float" style="width:500px">
    
    <form id="codeForm">

        
                <!--Nominal Voltage-->
                 <h3>Nominal voltage</h3>

        <label for="NominalVoltage">Enter NominalVoltage Value:</label>
        <input type="number" id="NominalVoltage" name="NominalVoltage" value="12" required> volts
        <br>
        <input type="checkbox" id="EnableNominalVoltageInterface" name="EnableNominalVoltageInterface" value="true" checked="checked">Allow the user to change the nominal voltage <br>
        <br>
        
                <!--Shut off Voltage Form-->
                 <h3>Shut Off voltage</h3>
        <label for="ShutOffVoltage">Enter ShutOffVoltage Value:</label> volts
        <input type="number" id="ShutOffVoltage" name="ShutOffVoltage" value="6" required> volts
        <br>
       <input type="checkbox" id="EnableShutOffVoltageInterface" name="EnableShutOffVoltageInterface" value="ShutOffEnabled">Allow the user to change the turn-back-on voltage <br>
<br>
            
        
                <!--Turn Back on Voltage Form-->
         <h3>Turn-back on Voltage:</h3>
          <label for="TurnBackOnVoltage">Default turn back on voltage:</label> volts
          <input type="number" id="TurnBackOnVoltage" name="TurnBackOnVoltage" value="10"> volts
          <br>
       <input type="checkbox" id="EnableTurnBackOnVoltageInterface" name="EnableTurnBackOnVoltageInterface" value="TurnBackOnEnabled">Allow the user to change the turn-back-on voltage <br>
        <br>
        
        
                <!--Current Range-->
         <h3>Current Range:</h3>
          <label for="LowCurrent">Minimum current:</label> amps
          <input type="number" id="LowCurrent" name="LowCurrent" value="10"> amps
          <br>
        
        
       <input type="checkbox" id="EnableCurrentRange" name="EnableCurrentRange" value="CurrentEditingEnabled">Allow the user to change the current range. <br>
        <br>       

        
        
        <!-- Override-->
              <h3>Overide:</h3>
              <input type="number" id="OverrideDelay" name="OverrideDelay" value="20"> minutes
              <br>
              Override Delay Time: <input type="checkbox" id="override" name="override" value="TRUE">
              <label for="override">Check to change overide delay time</label><br>

        
        
        <!-- Language-->
            <h3>Language:</h3>
             
                Default Language:
              <br>
              <input type="radio" id="english" name="LanguageSetting" value="english" checked="checked">
              <label for="english">English</label> 
              <input type="radio" id="spanish" name="LanguageSetting" value="spanish">
              <label for="spanish">Spanish</label><br>

              <br>
              <br>
  
        <input type="checkbox" id="EnableLanguageInterface" name="EnableLanguageInterface" value="LanguageChoiceEnabled">
              <label for="EnableLanguageInterface">Check to enable language selection</label><br>
              <br>
 
            

        <!-- Board-->
            <h3>Board:</h3>
             
              Select a device:
              <br>
              <input type="radio" id="ArduinoNano" name="DeviceSetting" value="ArduinoNano" checked="checked">
              <label for="ArduinoNano">Arduino Nano</label> 
        
                      <br>

        
              <input type="radio" id="ArduinoNanoESP32" name="DeviceSetting" value="ArduinoNanoESP32">
              <label for="ArduinoNanoEsp32">Arduino Nano ESP 32</label><br>
              
        

        
        <input type="radio" id="ArduinoUno" name="DeviceSetting" value="ArduinoUno">
              <label for="ArduinoUno">Arduino Uno</label> 
        
                      <br>

        
        
              <input type="radio" id="ArduinoMega" name="DeviceSetting" value="ArduinoMega">
              <label for="ArduinoMega">Arduino Mega</label><br>
              <br>
              <br>
  
 
            


            
                        
            <br>         
   
        
        
            <p id="exampleElement">Hover over me</p>
        
        
        
        
        <!--Buttons to begin the generation of the arduino file:-->
        <button type="button" onclick="generateCode()">Generate Arduino Code</button>
    </form>
    <br>
    <a id="downloadLink" style="display: none" download="arduino_code.ino">Download Arduino Code</a>

    <script>
        
        //Explanations
            
        const tooltipText = "This is a tooltip text.";

        // Get the HTML element by its ID
        const exampleElement = document.getElementById("exampleElement");

        // Set the tooltip text using the `title` attribute
        exampleElement.title = tooltipText;

           
        
        // explanations are given as arrays: ["English version", "Spanish version"];
        ExplanationNominalVoltage = ["This is the expected voltage of the battery when fully charged",""];
        ExplanationShutOffVoltage = ["This is the battery voltage at which the device will disconnect the load and the inverter from battery power.",""];
        ExplanationTurnBackOnVoltage = ["This is the battery voltage at which the device will reconnect the iinverter and the load if previously disconnected",""];
        ExplanationCurrentRange = ["",""];
        ExplanationOverride = ["This is the period of time the device will provide power to the inverter and the load, even with a battery voltage that is less than the set shut-off voltage if the end-user manually opts to reconnect after the load and the inverter have been disconnected by the device",""];
        ExplanationLanguage = ["This is the language that the end-user interface will appear in on the device.",""];
        ExplanationBoard = ["This is the microncontroller your low voltage disconnect is to be based upon.",""];
        
        
        
        
        
        function generateCode() {
            
            

            
            
            
            //Extract Variables From the Form
            
            
            //Nominal Battery Voltage JS Variable
            const NominalVoltage = document.getElementById("NominalVoltage").value;
            const EnableNominalVoltageBoolean=(document.getElementById("EnableNominalVoltageInterface").checked);
                  
            //Shut off Voltage JS Variable
            const ShutOffVoltage = document.getElementById("ShutOffVoltage").value;
            const EnableShutOffVoltageBoolean=(document.getElementById("EnableShutOffVoltageInterface").checked);
            
            
            //Turn back on voltage JS Variables
            const TurnBackOnVoltage = document.getElementById("TurnBackOnVoltage").value; //Turn Back on Voltage JS Variable
            const EnableTurnBackOnVoltageBoolean=(document.getElementById("EnableTurnBackOnVoltageInterface").checked);
           
            //Current Range
            
            
            const LowCurrent = document.getElementById("LowCurrent").value; //Turn Back on Voltage JS Variable

  
            //Override JS Variables
            const OverrideDelay = document.getElementById("OverrideDelay").value; //Turn Back on Voltage JS Variable
            const Override=(document.getElementById("override").checked);
           
            

            
            //Language JS Variables
            if(document.getElementById("english").checked==true)
            {

                var LanguageSetting = 1;


            }
            if(document.getElementById("spanish").checked == true)
            {
                var LanguageSetting = 2;


            }

                
            const EnableLanguageOption=(document.getElementById("EnableLanguageInterface").checked);
           
            //Device JS Variables
            if(document.getElementById("ArduinoNano").checked==true)
            {

                var DeviceSelection = 1;


            }
            if(document.getElementById("ArduinoNanoESP32").checked == true)
            {
                var DeviceSelection = 2;


            }
            if(document.getElementById("ArduinoUno").checked==true)
            {

                var DeviceSelection = 3;


            }
            if(document.getElementById("ArduinoMega").checked == true)
            {
                var DeviceSelection = 4;


            }
            
            
             //Set up pin assignments
            const PinData = [
    {
        "Name": "ArduinoNano",
        "VoltageProbe": "19", //"Pin A0"
        "lcdSDA": "23",//"Pin A4"
        "lcdSCL": "24",//"Pin A5"
        "EncoderCLK": "9",//"Pin D6"
        "EncoderDT": "10",//"Pin D7"
        "EncoderSW": "11",//"Pin D8"
        "PushButton": "12",//"Pin D9"
        "RelayOutput": "13"//"Pin10"
    },   
    {
        "Name": "ArduinoNanoESP32",
        "VoltageProbe": "19", //"Pin A0"
        "lcdSDA": "23",//"Pin A4"
        "lcdSCL": "24",//"Pin A5"
        "EncoderCLK": "9",//"Pin D6"
        "EncoderDT": "10",//"Pin D7"
        "EncoderSW": "11",//"Pin D8"
        "PushButton": "12",//"Pin D9"
        "RelayOutput": "13"//"Pin10"

    }, 
    {
        "Name": "ArduinoUno",
        "VoltageProbe": "14", //"Pin A0"
        "lcdSDA": "27",//"Pin A4"
        "lcdSCL": "19",//"Pin A5"
        "EncoderCLK": "12",//"Pin D6"
        "EncoderDT": "13",//"Pin D7"
        "EncoderSW": "14",//"Pin D8"
        "PushButton": "15",//"Pin D9"
        "RelayOutput": "4"//"Pin 10"
    },
    {
        "Name": "ArduinoMega",
        "VoltageProbe": "14", //"Pin A0"
        "lcdSDA": "27",//"Pin A4"
        "lcdSCL": "19",//"Pin A5"
        "EncoderCLK": "12",//"Pin D6"
        "EncoderDT": "13",//"Pin D7"
        "EncoderSW": "14",//"Pin D8"
        "PushButton": "10",//"Pin D10"
        "RelayOutput": "6"//"Pin D2"
    }
];

            // Generate Arduino code based on user input
             const arduinoCode =
/*Start*/        `//Milligan Engineering Low Voltage Disconnect Arduino Code`
                  +
                  `\n`
                  +
                  `\n \t`
                  +
/*Libraries*/     `//Specify Libraries`
                  +
                  `\n \t`
                  +
                  `#include <EEPROM.h> //This library is necesary for memory management`
                  +
                  `\n \t`
                  +
                  `const int EEPROM_ADDR = 0; // EEPROM address to store the user input`
                  +
                  `\n \t`
                  +
                  `const int MAX_INPUT_LENGTH = 32; // Maximum length of user input`
                  +
                  `\n \t`
                  +
                  `char userInput[MAX_INPUT_LENGTH] = {0}; // Buffer to store user input`
                  +
                  `\n \n`
                  +
/*Voltage Probe Related*/`//Voltage Probe related variables`
                  +
                  `\n \t`
                  +
                  `const float Resistor1 = 1.35*(10^6); //ohms`
                  +
                  `\n \t`
                  +
                  `const float Resistor2 = 750*(10^3); //ohms`
                  +
                  `\n \n`
                  +
/*Timer Related*/ `//Timer related variables`
                  +
                  `\n \t`
                  +
                  `unsigned long previousMillis = 0;`
                  +
                  `\n \t`
                  +
                  `const unsigned long TimerSafetyInterval = 600000;`
                  +
                  `// Set an interval in milliseconds to ensure that millis() rollover (happens once approximately every 50 days when millis() resets to zero) is never an issue for more than 10 minutes`
                  +
                  `\n \n`
                  +
/*Global Variables*/`//Global Variables:`
                  +
                  `\n \t`
                  +
                  `float NominalVoltage = ${NominalVoltage};`
                  +
                  `\n \t`
                  +
                  `bool EnableNominalVoltageInterface = ${EnableNominalVoltageBoolean};`
                  +
                  `\n \t`
                  +
                  `float ShutOffVoltage = ${ShutOffVoltage};`
                  +
                  `\n \t`
                  +
                  `bool EnableShutOffVoltageInterface = ${EnableShutOffVoltageBoolean};`
                  +
                  `\n \t`
                  +
                  `float TurnBackOnVoltage = ${TurnBackOnVoltage};`
                  +
                  `\n \t`
                  +
                  `bool EnableTurnBackOnVoltageInterface = ${EnableTurnBackOnVoltageBoolean};`
                  +
                  `\n \t`
                  +
                  `bool Override = ${Override};`
                  +
                  `\n \t`
                  +
                  `bool OverrideDelay = ${OverrideDelay}*60000; //milliseconds`
                  +
                  `\n \t`
                  +
                  `int TimeDelay = 30000; //Delay for turning back on or off`
                  +
                  `\n \t`
                  +
                  `int LanguageSetting = ${LanguageSetting};`
                  +
                  `\n \t`
                  +
                  `bool EnableLanguageInterface = ${EnableLanguageOption};`
                  +
                  `\n \t`
                  +
                  `int DeviceSetting = ${DeviceSelection};`
                  +
                  `\n \n \t`
                  +
/*Pin Assignments*/`//Get Pin Assignments:`
                  +
                  `\n \t`
                  +
                 `int VoltageProbe= ${PinData[DeviceSelection-1].VoltageProbe};`
                  +
                  `\n \t`
                  +
                  `int lcdSDA= ${PinData[DeviceSelection-1].lcdSDA};`
                  +
                  `\n \t`
                  +
                  `int lcdSCL= ${PinData[DeviceSelection-1].lcdSCL};`
                  +
                  `\n \t`
                  +
                  `int EncoderCLK = ${PinData[DeviceSelection-1].EncoderCLK};`
                  +
                  `\n \t`
                  +
                  `int EncoderDT = ${PinData[DeviceSelection-1].EncoderDT};`
                  +
                  `\n \t`
                  +
                  `int EncoderSW = ${PinData[DeviceSelection-1].EncoderSW};`
                  +
                  `\n \t`
                  +
                  `int PushButton = ${PinData[DeviceSelection-1].PushButton};`
                  +
                  `\n \t`
                  +
                  `int RelayOutput = ${PinData[DeviceSelection-1].RelayOutput};`
                  +
                  `\n \n`
                  +
/*States*/        `//Initialize States`
                  +
                  `\n \t`
                  +
                  `bool VoltageDisconnectState = true;`
                  +
                  `\n \t`
                  +
                  `bool LoadOnState = false;`
                  +
                  `\n \t`
                  +
                  `bool CurrentDisconnectState = false;`
                  +
                  `\n \n`
                  +
/*Void Read User Input*/`void readUserInput()`
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +
                  `// Read user input from EEPROM and load it into the userInput buffer`
                  +
                  `\n \t`
                  +
                  `for (int i = 0; i < MAX_INPUT_LENGTH; i++)`
                  +
                  `{`
                  +
                  `\n \t \t`
                  +
                  `char c = EEPROM.read(EEPROM_ADDR + i);`
                  +
                  `\n \t \t`
                  +
                  `if (c == '\0')`
                  +
                  `\n \t \t`
                  +
                  `{`
                  +
                  `\n \t \t \t`
                  +
                  `break; // End of stored data`
                  +
                  `\n \t \t`
                  +
                  `} //End of if statement`
                  +
                  `\n \t \t`
                  +
                  `userInput[i] = c;`
                  +
                  `\n \t`
                  +
                  `}//end of for loop`
                  +
                  `\n`
                  +
                  `} //end of Read User Input`
                  +
                  `\n \n`
                  +
/*Void Write User Input*/`void writeUserInput()`
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +
                  `// Write user input from the userInput buffer to EEPROM`
                  +
                  `\n \t`
                  +
                  `for (int i = 0; i < MAX_INPUT_LENGTH; i++)`
                  +
                  `\n \t`
                  +
                  `{`
                  +
                  `\n \t \t`
                  +
                  `if (userInput[i] == '\0')`
                  +
                  `\n \t \t`
                  +
                  `{`
                  +
                  `\n \t \t \t`
                  +
                  `break; // End of input`
                  +
                  `\n \t \t`
                  +
                  `} //end of if statment`
                  +
                  `\n \t`
                  +
                  `EEPROM.write(EEPROM_ADDR + i, userInput[i]);`
                  +
                  `\n \t`
                  +
                  `} //end of for loop`
                  +
                  `\n \t`
                  +
                  `EEPROM.write(EEPROM_ADDR + MAX_INPUT_LENGTH, '\0'); // Null-terminate the string`
                  +
                  `\n`
                  +
                  `} //end of writeUserInput`
                  +
                  `\n`
                  +
                  `\n \n`
                  +
                  `//Measure Voltage Function`
                  +
                  `\n \n`
                  +
/*Voltage Measurement*/`float MeasureVoltage() `
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +
                  `float VoltageMeasurement = analogRead(VoltageProbe)*(5/1023); //The ratio is 5 Volts (max voltage that can go into a pin)/ 1023 (AnalogRead() measures between 0 and 1023`
                  +
                  `\n \t`
                  +
                  `float BatteryVoltage = VoltageMeasurement*(Resistor1+Resistor2)/(Resistor2); //This uses voltage divider math to caclulate the battery voltage.`
                  +
                  `\n \t`
                  +
                  `Serial.print("Voltage measured at probe = ");`
                  +
                  `\n \t`
                  +
                   `Serial.print(VoltageMeasurement);`
                  +
                  `\n \t`
                  +
                  `\n \t`
                  +
                  `Serial.print(`
                  +
                  String.raw`'\n'`
                  +
                  `);`
                  +
                  `\n \t`
                  +
                  `Serial.print("Battery Voltage = ");` 
                  +
                  `\n \t`
                  +
                  `Serial.print(BatteryVoltage);`
                  +
                  `\n \t`
                  +
                  `Serial.print(`
                  +
                  String.raw`'\n'`
                  +
                  `);`
                  +
                  `\n \t`
                  +
                  `return(BatteryVoltage);`
                  +
                  `\n`
                  +
                  `} //end of function, MeasureVoltage()`
                  +
                  `\n \n`
                  +
/*Turn off output*/`void TurnOffOutput()`
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +
                  `digitalWrite(RelayOutput, LOW);  // sets the relay output off`
                  +
                  `\n \t`
                  +
                  `Serial.print("Output disconnected.");`
                  +
                  `\n`
                  +
                  `} //end of function, TurnOffOutput()`
                  +
                  `\n \n`
                  +
/*Turn on output*/`void TurnOnOutput() `
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +
                  `digitalWrite(RelayOutput, HIGH);  // sets the relay output on`
                  +
                  `\n \t`
                  +
                  `Serial.print("Output connected.");`
                  +
                  `\n`
                  +
                  `} //end of function, TurnOnOutput()`
                  +
                  `\n \n`
                  +
/*Start Timer*/   `void StartTimer() `
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +
                  `unsigned long currentMillis = millis();`
                  +
                  `\n \t`
                  +
                  `if (currentMillis - previousMillis >= TimerSafetyInterval)`
                  +
                  `\n \t`
                  +
                  `{`
                  +
                  `\n \t \t`
                  +
                  `previousMillis = currentMillis;`
                  +
                  `\n \t \t`
                  +
                  `\n \t`
                  +
                  `} // end of if statment`
                  +
                  `\n`
                  +
                  `} //end of StartTimer()`
                  +
                  `\n \n`
                  +
/*Check For User Input*/`void SerialInput()`
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +  
                  `// Check for user input`
                  +
                  `\n \t`
                  +
                  `if (Serial.available() > 0)`
                  +
                  `\n \t`
                  +
                  `{`
                  +
                  `\n \t \t`
                  +
                  `// Read user input until a newline character is received`
                  +
                  `\n \t \t`
                  +
                  `Serial.readBytesUntil(`
                  +
                  String.raw`'\n'`
                  +
                  `, userInput, MAX_INPUT_LENGTH);`
                  +
                  `\n \t \t`
                  +
                  `Serial.print("User input: ");`
                  +
                  `\n \t \t`
                  +
                  `Serial.println(userInput);`
                  +
                  `\n \n \t \t`
                  +
                  `// Store user input in EEPROM`
                  +
                  `\n \t \t`
                  +
                  `writeUserInput();`
                  +
                  `// Read sensor value and print it`
                  +
                  `\n \t \t`
                  +
                  `int reading = analogRead(A0);`
                  +
                  `\n \t \t`
                  +
                  `Serial.println(reading);`
                  +
                  `\n \t \t`
                  +
                  `delay(1000);`
                  +
                  `\n \t`
                  +
                  `} //End of if statement`
                  +
                  `\n`
                  +
                  `} //End of SerialInput()`
                  +
                  `\n \n`
                  +
/*Void Setup*/    `void setup()`
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +
                  `// Initialize serial communication`
                  +
                  `\n \t`
                  +
                  `Serial.begin(9600);`
                  +
                  `\n \t`
                  +
                  `readUserInput();`
                  +
                  `\n`
                  +
                  `} //End of void setup`
                  +
                  `\n \n`
                  +
/*Void Loop*/     `void loop()`
                  +
                  `\n`
                  +
                  `{`
                  +
                  `\n \t`
                  +
                  `if ((MeasureVoltage()<ShutOffVoltage) && (Override=false))`
                  +
                  `\n \t`
                  +
                  `{`
                  +
                  `\n \t \t`
                  +
                  `TurnOffOutput();`
                  +
                  `\n \t \t`
                  +
                  `\n \t`
                  +
                  `} //end of if statement`
                  +
                   `if ((MeasureVoltage()<ShutOffVoltage) && (Override=true))`
                  +
                  `\n \t`
                  +
                  `{`
                  +
                  `\n \t \t`
                  +
                  `TurnOnOutput();`
                  +
                  `\n \t \t`
                  +
                  `\n \t`
                  +
                  `} //end of if statement`
                  +
                  `\n \t`
                  +
                  `if (MeasureVoltage()>TurnBackOnVoltage)`
                  +
                  `\n \t`
                  +
                  `{`
                  +
                  `\n \t \t`
                  +
                  `TurnOnOutput();`
                  +
                  `\n \t \t`
                  +
                  `\n \t`
                  +
                  `} //end of if statement`
                  +
                   `\n \t`
                  +
                  `if (MeasureVoltage()>ShutOffVoltage)`
                  +
                  `\n \t`
                  +
                  `{`
                  +
                  `\n \t \t`
                  +
                  `TurnOnOutput();`
                  +
                  `\n \t \t`
                  +
                  `\n \t`
                  +
                  `} //end of if statement`
                  +
                  `\n \t`
                  +
                  `\n \t`
                  +
                  `\n`
                  +
                  `} //End of Void Loop`

            ;//end of arduinoCode constant

            // Create a Blob containing the Arduino code
            const AssembledArduinoCode = new Blob([arduinoCode], { type: 'text/plain' });


            
            
            // Create a download link
            const downloadLink = document.getElementById("downloadLink");
            downloadLink.href = URL.createObjectURL(AssembledArduinoCode);
            downloadLink.style.display = "block";
            a.click();
    setTimeout(function(){
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
    }, 100); 
            /*
            
            //Open a new window
            // Create a new window and get a reference to it
            var newWindow = window.open('', '_blank', 'width=400,height=200');

            // Write the string content to the new window
            newWindow.document.write(AssembledArduinoCode).value;


            // Close the document to ensure proper rendering
            newWindow.document.close();
            */
        }
    </script>
</body>
</html>